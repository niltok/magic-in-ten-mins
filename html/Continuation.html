<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0">
<title>
ååˆ†é’Ÿé­”æ³•ç»ƒä¹ </title>
<style>
body { max-width: 650px; margin: auto; width: 90%; margin-top: 10%; margin-bottom: 10%; color: #0B0E26; background: #FAFAFC; line-height: 2em; }
body { font-family: -apple-system,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Microsoft YaHei,Source Han Sans SC,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif; }
h1 { font-size: 2.5em; color: #EF96AB; line-height: 1.5em; }
h2 { margin-top: 2em; line-height: 1.5em; }
blockquote { color: gray; margin: 0; padding: 1 1 1 20; border-left: 5px solid #EF96AB; }
code, pre { font-family: Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace; background: #FCF6FC; }
pre { overflow-x: auto; padding: 10px; }
a { color: #02AEF1; text-decoration: none; }
@media (prefers-color-scheme: dark) { body { color: #D8D8D6; background: #0E0E10; } }
@media (prefers-color-scheme: dark) { pre, code { color: #D8D8D6; background: #0E0F1F; } }
.hljs-keyword { color: #F288AF; }
.hljs-comment { color: #929CA6; }
.hljs-string { color: #0594A6; }
.hljs-title { color: #4581D9 }
</style>
</head>
<body>
<p>
<a href="https://magic.huohuo.moe">ğŸ HomepageğŸ </a> | <a href="https://github.com/niltok/magic-in-ten-mins">â­Star me on GitHubâ­</a></p>
<h1 id="ååˆ†é’Ÿé­”æ³•ç»ƒä¹ ï¼šç»­å»¶">ååˆ†é’Ÿé­”æ³•ç»ƒä¹ ï¼šç»­å»¶</h1>
<h3 id="by-ã€Œç©ç«ã€">By ã€Œç©ç«ã€</h3>
<blockquote>
<p>å‰ç½®æŠ€èƒ½ï¼šç®€å•JavaåŸºç¡€</p>
</blockquote>
<h2 id="ç»­å»¶">ç»­å»¶</h2>
<p>ç»­å»¶ï¼ˆContinuationï¼‰æ˜¯æŒ‡ä»£è¡¨ä¸€ä¸ªç¨‹åºæœªæ¥çš„å‡½æ•°ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªç¨‹åºè¿‡å»è®¡ç®—çš„ç»“æœã€‚</p>
<p>æ¯”å¦‚å¯¹äºè¿™ä¸ªç¨‹åºï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>;                <span class="hljs-comment">// 1</span>
    i++;                      <span class="hljs-comment">// 2</span>
    System.out.println(i);    <span class="hljs-comment">// 3</span>
}</code></pre>
<p>å®ƒç¬¬äºŒè¡Œä»¥åŠä¹‹åçš„ç»­å»¶å°±æ˜¯ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cont</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
    i++;                      <span class="hljs-comment">// 2</span>
    System.out.println(i);    <span class="hljs-comment">// 3</span>
}</code></pre>
<p>è€Œç¬¬ä¸‰è¡Œä¹‹åçš„ç»­å»¶æ˜¯ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cont</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
    System.out.println(i);    <span class="hljs-comment">// 3</span>
}</code></pre>
<p>å®é™…ä¸Šå¯ä»¥æŠŠè¿™æ•´ä¸ªç¨‹åºçš„æ¯ä¸€è¡Œæ”¹æˆä¸€ä¸ªç»­å»¶ç„¶åç”¨å‡½æ•°è°ƒç”¨ä¸²èµ·æ¥å˜æˆå’Œåˆšæ‰çš„ç¨‹åºä¸€æ ·çš„ä¸œè¥¿ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cont1</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>;                <span class="hljs-comment">// 1</span>
    cont2(i);
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cont2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
    i++;                      <span class="hljs-comment">// 2</span>
    cont3(i);
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cont3</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>{
    System.out.println(i);    <span class="hljs-comment">// 3</span>
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
    cont1();
}</code></pre>
<h2 id="ç»­å»¶ä¼ é€’é£æ ¼">ç»­å»¶ä¼ é€’é£æ ¼</h2>
<p>ç»­å»¶ä¼ é€’é£æ ¼ï¼ˆContinuation-Passing Style, CPSï¼‰æ˜¯æŒ‡æŠŠç¨‹åºçš„ç»­å»¶ä½œä¸ºå‡½æ•°çš„å‚æ•°æ¥è·å–å‡½æ•°è¿”å›å€¼çš„ç¼–ç¨‹æ€è·¯ã€‚</p>
<p>å¬ä¸Šå»å¾ˆéš¾ç†è§£ï¼ŒæŠŠä¸Šé¢çš„ä¸‰ä¸ª <code>cont</code> å‡½æ•°æ”¹æˆCPSå°±å¾ˆå¥½ç†è§£äº†ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">logic1</span><span class="hljs-params">(Consumer&lt;Integer&gt; f)</span> </span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>;
    f.accept(i); <span class="hljs-comment">// return i</span>
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">logic2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, Consumer&lt;Integer&gt; f)</span> </span>{
    i++;
    f.accept(i);
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">logic3</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, Consumer&lt;Integer&gt; f)</span> </span>{
    System.out.println(i);
    f.accept(i);
}
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{
         logic1( <span class="hljs-comment">// è·å–è¿”å›å€¼ i</span>
    i -&gt; logic2(i, 
    i -&gt; logic3(i, 
    i -&gt; {})));
}</code></pre>
<p>æ¯ä¸ª <code>logic</code> å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•° <code>f</code> å°±æ˜¯æ•´ä¸ªç¨‹åºçš„ç»­å»¶ï¼Œè€Œåœ¨æ¯ä¸ªå‡½æ•°çš„é€»è¾‘ç»“æŸåæ•´ä¸ªç¨‹åºçš„ç»­å»¶ä¹Ÿå°±æ˜¯æœªæ¥ä¼šè¢«è°ƒç”¨ã€‚è€Œ <code>test</code> å‡½æ•°æŠŠæ•´ä¸ªç¨‹åºç»„è£…èµ·æ¥ã€‚</p>
<p>å°æœ‹å‹ï¼Œä½ æœ‰æ²¡æœ‰è§‰å¾—æœ€åçš„ <code>test</code> å‡½æ•°å†™æ³•è¶…çœ¼ç†Ÿå‘¢ï¼Ÿå®é™…ä¸Šè¿™ä¸ªå†™æ³•å°±æ˜¯ Monad çš„å†™æ³•ï¼Œ Monad çš„å†™æ³•å°±æ˜¯ CPS ã€‚</p>
<p>å¦ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œè¿™ä¹Ÿæ˜¯å›è°ƒå‡½æ•°çš„å†™æ³•ï¼Œæ¯ä¸ª <code>logic</code> å‡½æ•°å®Œæˆé€»è¾‘åè°ƒç”¨äº†å›è°ƒå‡½æ•° <code>f</code> æ¥å®Œæˆå‰©ä¸‹çš„é€»è¾‘ã€‚å®é™…ä¸Šï¼Œå¼‚æ­¥å›è°ƒæ€æƒ³å¾ˆå¤§ç¨‹åº¦ä¸Šå°±æ˜¯ CPS ã€‚</p>
<h2 id="æœ‰ç•Œç»­å»¶">æœ‰ç•Œç»­å»¶</h2>
<p>è€ƒè™‘æœ‰å¦ä¸€ä¸ªå‡½æ•° <code>callT</code> è°ƒç”¨äº† <code>test</code> å‡½æ•°ï¼Œå¦‚ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">callT</span><span class="hljs-params">()</span> </span>{
    test();
    System.out.println(<span class="hljs-number">3</span>);
}</code></pre>
<p>é‚£ä¹ˆå¯¹äº <code>logic</code> å‡½æ•°æ¥è¯´è°ƒç”¨çš„ <code>f</code> è¿™ä¸ªç»­å»¶å¹¶ä¸åŒ…æ‹¬ <code>callT</code> ä¸­çš„æ‰“å°è¯­å¥ï¼Œé‚£ä¹ˆå®é™…ä¸Š <code>f</code> è¿™ä¸ªç»­å»¶å¹¶ä¸æ˜¯æ•´ä¸ªå‡½æ•°çš„æœªæ¥è€Œæ˜¯ <code>test</code> è¿™ä¸ªå‡½æ•°å±€éƒ¨çš„æœªæ¥ã€‚</p>
<p>è¿™æ ·ä»£è¡¨å±€éƒ¨ç¨‹åºçš„æœªæ¥çš„å‡½æ•°å°±å«æœ‰ç•Œç»­å»¶ï¼ˆDelimited Continuationï¼‰ã€‚</p>
<p>å®é™…ä¸Šåœ¨å¤§å¤šæ—¶å€™ç”¨çš„æ¯”è¾ƒå¤šçš„è¿˜æ˜¯æœ‰ç•Œç»­å»¶ï¼Œå› ä¸ºåœ¨ Java ä¸­è·å–æ•´ä¸ªç¨‹åºçš„ç»­å»¶è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œè¿™éœ€è¦å…¨ç”¨ CPS çš„å†™æ³•ã€‚</p>
<h2 id="å¼‚å¸¸">å¼‚å¸¸</h2>
<p>æ‹¿åˆ°äº†æœ‰ç•Œç»­å»¶æˆ‘ä»¬å°±èƒ½å®ç°ä¸€å¤§å †æ§åˆ¶æµé­”æ³•ï¼Œè¿™é‡Œæ‹¿å¼‚å¸¸å¤„ç†ä¸¾ä¸ªä¾‹å­ï¼Œé€šè¿‡CPSå†™æ³•è‡ªå·±å®ç°ä¸€ä¸ª <code>try-throw</code> ã€‚</p>
<p>é¦–å…ˆæœ€åŸºæœ¬çš„æƒ³æ³•æ˜¯æŠŠæ¯æ¬¡è°ƒç”¨ <code>try</code> çš„ <code>catch</code> å‡½æ•°ä¿å­˜èµ·æ¥ï¼Œç”±äº <code>try</code> å¯å±‚å±‚åµŒå¥—æ‰€ä»¥æ¯æ¬¡å‹å…¥æ ˆä¸­ï¼Œç„¶å <code>throw</code> çš„æ—¶å€™å°†æœ€è¿‘çš„ <code>catch</code> å‡½æ•°å–å‡ºæ¥è°ƒç”¨å³å¯ï¼š</p>
<pre><code class="language-java">Stack&lt;Consumer&lt;Exception&gt;&gt; cs = <span class="hljs-keyword">new</span> Stack&lt;&gt;();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Try</span><span class="hljs-params">(Consumer&lt;Runnable&gt; body,
         BiConsumer&lt;Exception, Runnable&gt; handler,
         Runnable cont)</span> </span>{
    cs.push(e -&gt; handler.accept(e, cont));
    body.accept(cont);
    cs.pop();
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Throw</span><span class="hljs-params">(Exception e)</span> </span>{
    cs.peek().accept(e);
}</code></pre>
<p>è¿™é‡Œ <code>body</code> ã€ <code>Try</code> ã€ <code>handler</code> çš„æœ€åä¸€ä¸ªå‚æ•°éƒ½æ˜¯è¿™ä¸ªç¨‹åºçš„æœ‰ç•Œç»­å»¶ã€‚</p>
<p>æœ‰äº† <code>try-throw</code> å°±å¯ä»¥æŒ‰ç…§CPSé£æ ¼è°ƒç”¨å®ƒä»¬æ¥è¾¾åˆ°å¤„ç†å¼‚å¸¸çš„ç›®çš„ï¼š</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> t)</span> </span>{
    Try(
    cont -&gt; {
        System.out.println(<span class="hljs-string">&quot;try&quot;</span>);
        <span class="hljs-keyword">if</span> (t == <span class="hljs-number">0</span>) Throw(<span class="hljs-keyword">new</span> ArithmeticException());
        <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-number">100</span> / t);
            cont.run();
        }
    },
    (e, cont) -&gt; {
        System.out.println(<span class="hljs-string">&quot;catch&quot;</span>);
        cont.run();
    },
    () -&gt; System.out.println(<span class="hljs-string">&quot;final&quot;</span>));
}</code></pre>
<p>è°ƒç”¨ <code>test(0)</code> ä¼šå¾—åˆ°ï¼š</p>
<pre><code><span class="hljs-keyword">try</span>
<span class="hljs-keyword">catch</span>
<span class="hljs-keyword">final</span></code></pre>
<p>è€Œè°ƒç”¨ <code>test(1)</code> ä¼šå¾—åˆ°ï¼š</p>
<pre><code><span class="hljs-keyword">try</span>
<span class="hljs-number">100</span>
<span class="hljs-keyword">final</span></code></pre>
</body>
</html>
