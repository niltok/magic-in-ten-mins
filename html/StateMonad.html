<!DOCTYPE html><html lang="zh-CN" prefix="og: https://ogp.me/ns#">
<head >
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title >
ååˆ†é’Ÿé­”æ³•ç»ƒä¹ </title>
<style >
@font-face {
    font-family: "subset body font";
    src: url("body.woff2") format("woff2");
}

@font-face {
    font-family: "subset code font";
    src: url("code.woff2") format("woff2");
}

@font-face {
    font-family: "subset emoji font";
    src: url("emoji.woff2") format("woff2");
}

body {
    max-width: 35em;
    margin: auto;
    width: 90%;
    margin-top: 10%;
    margin-bottom: 10%;
    color: #0B0E26;
    background: #FAFAFC;
    line-height: 1.75em;
    text-rendering: optimizeLegibility;
    text-align: justify;
}

html {
    scroll-behavior: smooth;
    font-size: calc(min(.35vw + 16px, 25px));
    font-family: "subset body font", "Source Han Serif SC", "Noto Serif SC", "Songti SC", SimSun, "AR PL Sungti", "subset emoji font", serif;
}

h1 {
    font-size: 2.5rem;
    color: #EF96AB;
    line-height: 1.5em;
}

h2 {
    margin-top: 2rem;
    line-height: 1.5em;
}

h1,
h2,
h3 {
    /* text-align: center; */
}

blockquote {
    color: gray;
    margin: 0;
    padding: 1px 0 1px 1.2em;
    border-left: .3em solid #EF96AB;
}

code,
pre {
    font-size: 0.9rem;
    line-height: 1.8em;
    font-family: "subset code font", "ç­‰è·æ›´çº±é»‘ä½“ SC", "JetBrains Mono", "Fira Code", Menlo, Monaco, source-code-pro, Courier New, Consolas, "subset emoji font", monospace;
    background: #FCF6FC;
    border-radius: 3px;
    padding-inline: 0.3em;
}

pre {
    overflow-x: auto;
    padding: 1em 1.5em;
}

pre>code {
    padding-inline: 0;
}

::-webkit-scrollbar,
.element::-webkit-scrollbar,
.element {
    /* opacity: 0.5; */
}

a {
    color: #02AEF1;
    text-decoration: none;
}

@media (prefers-color-scheme: dark) {
    body {
        color: #D8D8D6;
        background: #0E0E10;
    }
}

@media (prefers-color-scheme: dark) {

    pre,
    code {
        color: #D8D8D6;
        background: #0E0F1F;
    }
}

.hljs-keyword {
    color: #F288AF;
}

.hljs-comment {
    color: #929CA6;
}

.hljs-string {
    color: #0594A6;
}

.hljs-title {
    color: #4581D9;
}

.hljs-type,
.hljs-built_in {
    color: #fca311;
}</style>
</head>
<body >
<p >
<a href="https://magic.huohuo.moe">ğŸ HomepageğŸ </a> | <a href="https://github.com/niltok/magic-in-ten-mins">â­Star me on GitHubâ­</a></p>
<h1 id="ååˆ†é’Ÿé­”æ³•ç»ƒä¹ ï¼šçŠ¶æ€å•å­">ååˆ†é’Ÿé­”æ³•ç»ƒä¹ ï¼šçŠ¶æ€å•å­</h1>
<h3 id="by-ã€Œç©ç«ã€">By ã€Œç©ç«ã€</h3>
<blockquote>
<p>å‰ç½®æŠ€èƒ½ï¼šJavaåŸºç¡€ï¼ŒHKTï¼ŒMonad</p>
</blockquote>
<h2 id="å‡½æ•°å®¹å™¨">å‡½æ•°å®¹å™¨</h2>
<p>å¾ˆæ˜¾ç„¶Javaæ ‡å‡†åº“ä¸­çš„å„ç±»å®¹å™¨éƒ½æ˜¯å¯ä»¥çœ‹æˆæ˜¯å•å­çš„ï¼Œ <code>Stream</code> ç±»ä¹Ÿç»™å‡ºäº†è¿™äº›ç±»çš„ <code>flatMap</code> å®ç°ã€‚ä¸è¿‡åœ¨å‡½æ•°å¼çš„ç†è®ºä¸­å•å­ä¸ä»…ä»…å¯ä»¥æ˜¯å®ä¾‹æ„ä¹‰ä¸Šçš„å®¹å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–æŠ½è±¡æ„ä¹‰ä¸Šçš„å®¹å™¨ï¼Œæ¯”å¦‚å‡½æ•°ã€‚</p>
<p>å¯¹äºä¸€ä¸ªå½¢å¦‚<code> Function&lt;S, Complex&lt;A&gt;&gt;</code> å½¢å¼çš„å‡½æ•°æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹æˆåŒ…å«äº†ä¸€ä¸ª <code>A</code> çš„æƒ°æ€§å®¹å™¨ï¼Œåªæœ‰åœ¨ç»™å‡º <code>S</code> çš„æ—¶å€™æ‰èƒ½çŸ¥é“ <code>A</code> çš„å€¼ã€‚å¯¹äºè¿™æ ·å½¢å¼çš„å‡½æ•°æˆ‘ä»¬åŒæ ·èƒ½å†™å‡ºå¯¹åº”çš„ <code>flatMap</code> ï¼Œè¿™é‡Œå°±æ‹¿çŠ¶æ€å•å­ä¸¾ä¾‹å­ã€‚</p>
<h2 id="çŠ¶æ€å•å­">çŠ¶æ€å•å­</h2>
<p>çŠ¶æ€å•å­ï¼ˆState Monadï¼‰æ˜¯ä¸€ç§å¯ä»¥åŒ…å«ä¸€ä¸ªâ€œå¯å˜â€çŠ¶æ€çš„å•å­ï¼Œæˆ‘è¿™é‡Œç”¨äº†å¼•å·æ˜¯å› ä¸ºå°½ç®¡çŠ¶æ€éšç€é€»è¾‘æµåœ¨å˜åŒ–ä½†æ˜¯åœ¨å†…å­˜é‡Œé¢å®é™…ä¸Šéƒ½æ˜¯ä¸å˜é‡ã€‚</p>
<p>å…¶æœ¬è´¨å°±æ˜¯åœ¨æ¯æ¬¡çŠ¶æ€å˜åŒ–çš„æ—¶å€™å°†æ–°çŠ¶æ€ä½œä¸ºä»£è¡¨æ¥ä¸‹æ¥é€»è¾‘çš„å‡½æ•°çš„è¾“å…¥ã€‚æ¯”å¦‚å¯¹äºï¼š</p>
<pre><code class="language-java">i = i + <span class="hljs-number">1</span>;
System.out.println(i);
</code></pre>
<p>å¯ä»¥ç”¨çŠ¶æ€å•å­çš„æ€è·¯æ”¹å†™æˆï¼š</p>
<pre><code class="language-java">(v -&gt; System.out.println(v)).apply(i + <span class="hljs-number">1</span>);
</code></pre>
<p>æœ€ç®€å•çš„ç†è§£å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªåŒ…å«å‡½æ•°çš„å¯¹è±¡ï¼š</p>
<pre><code class="language-java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">S</span>, <span class="hljs-title">A</span>&gt; 
    <span class="hljs-keyword">implements</span> <span class="hljs-title">HKT</span>&lt;<span class="hljs-title">State</span>&lt;<span class="hljs-title">S</span>, ?&gt;, <span class="hljs-title">A</span>&gt; </span>{
    
    Function&lt;S, StateData&lt;A, S&gt;&gt; runState;
    
    <span class="hljs-comment">// Pair alias</span>
    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateData</span>&lt;<span class="hljs-title">A</span>, <span class="hljs-title">S</span>&gt; </span>{
        S state;
        A value;
        StateData(A v, S s) {
            state = s;
            value = v;
        }
    }
    
    <span class="hljs-comment">// Constructor</span>
    State(Function&lt;S, 
          StateData&lt;A, S&gt;&gt; f) { 
        runState = f; 
    }
    
    <span class="hljs-comment">// Transformer</span>
    <span class="hljs-keyword">static</span> &lt;S, A&gt; <span class="hljs-function">State&lt;S, A&gt;
    <span class="hljs-title">narrow</span><span class="hljs-params">(HKT&lt;State&lt;S, ?&gt;, A&gt; v)</span> </span>{
        <span class="hljs-keyword">return</span> (State&lt;S, A&gt;) v;
    }
}
</code></pre>
<p>è¿™é‡Œä¸ºäº†å¥½çœ‹å®šä¹‰äº†ä¸€ä¸ª <code>StateData</code> ç±»ï¼ŒåŒ…å«å˜åŒ–åçš„çŠ¶æ€å’Œè®¡ç®—ç»“æœã€‚è€Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ <code>runState</code> å‡½æ•°å¯¹è±¡ï¼Œé€šè¿‡ç»„åˆè¿™ä¸ªå‡½æ•°å¯¹è±¡æ¥ä½¿å˜åŒ–çš„çŠ¶æ€åœ¨é€»è¾‘é—´ä¼ é€’ã€‚</p>
<p><code>State</code> æ˜¯ä¸€ä¸ª Monad ï¼ˆæ³¨é‡Šä¸­æ˜¯ç®€åŒ–çš„ä¼ªä»£ç ï¼‰ï¼š</p>
<pre><code class="language-java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateM</span>&lt;<span class="hljs-title">S</span>&gt; 
    <span class="hljs-keyword">implements</span> <span class="hljs-title">Monad</span>&lt;<span class="hljs-title">State</span>&lt;<span class="hljs-title">S</span>, ?&gt;&gt; </span>{
    
    <span class="hljs-keyword">public</span> &lt;A&gt; HKT&lt;State&lt;S, ?&gt;, A&gt; 
    pure(A v) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> State&lt;&gt;(s -&gt; 
            <span class="hljs-keyword">new</span> State.StateData&lt;&gt;(v, s));
    }
    
    <span class="hljs-comment">// &lt;A, B&gt; State&lt;S, B&gt; </span>
    <span class="hljs-comment">// flatMap(State&lt;S, A&gt; ma, </span>
    <span class="hljs-comment">//     Function&lt;A, State&lt;S, B&gt; f)</span>
    <span class="hljs-keyword">public</span> &lt;A, B&gt; HKT&lt;State&lt;S, ?&gt;, B&gt;
    flatMap(HKT&lt;State&lt;S, ?&gt;, A&gt; ma, 
        Function&lt;A,
            HKT&lt;State&lt;S, ?&gt;, B&gt;&gt; f) {
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> State&lt;&gt;(s -&gt; {
            
            <span class="hljs-comment">// r = ma.runState(s)</span>
            State.StateData&lt;A, S&gt; r = 
                State
                .narrow(ma)
                .runState
                .apply(s);
            
            <span class="hljs-comment">// return f(r.value)</span>
            <span class="hljs-comment">//     .runState(r.state)</span>
            <span class="hljs-keyword">return</span> State
                .narrow(f.apply(r.value))
                .runState
                .apply(r.state);
        });
    }
}
</code></pre>
<p><code>pure</code> æ“ä½œç›´æ¥è¿”å›å½“å‰çŠ¶æ€å’Œç»™å®šçš„å€¼ï¼Œ <code>flatMap</code> æ“ä½œåªéœ€è¦æŠŠ <code>ma</code> ä¸­çš„ <code>A</code> å–å‡ºæ¥ç„¶åä¼ ç»™ <code>f</code> ï¼Œå¹¶å¤„ç†å¥½ <code>state</code> ã€‚</p>
<p>ä»…ä»…è¿™æ ·çš„è¯ <code>State</code> ä½¿ç”¨èµ·æ¥å¹¶ä¸æ–¹ä¾¿ï¼Œè¿˜éœ€è¦å®šä¹‰ä¸€äº›å¸¸ç”¨çš„æ“ä½œæ¥è¯»å–å†™å…¥çŠ¶æ€ï¼š</p>
<pre><code class="language-java"><span class="hljs-comment">// class StateM&lt;S&gt;</span>
<span class="hljs-comment">// è¯»å–</span>
HKT&lt;State&lt;S, ?&gt;, S&gt; get = 
    <span class="hljs-keyword">new</span> State&lt;&gt;(s -&gt; 
        <span class="hljs-keyword">new</span> State.StateData&lt;&gt;(s, s));
<span class="hljs-comment">// å†™å…¥</span>
HKT&lt;State&lt;S, ?&gt;, S&gt; put(S s) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> State&lt;&gt;(any -&gt; 
        <span class="hljs-keyword">new</span> State.StateData&lt;&gt;(any, s));
}
<span class="hljs-comment">// ä¿®æ”¹</span>
HKT&lt;State&lt;S, ?&gt;, S&gt; 
modify(Function&lt;S, S&gt; f) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> State&lt;&gt;(s -&gt; 
        <span class="hljs-keyword">new</span> State.StateData&lt;&gt;(
            s, 
            f.apply(s)));
}
</code></pre>
<p>ä½¿ç”¨çš„è¯è¿™é‡Œä¸¾ä¸ªæ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ä¾‹å­ï¼š</p>
<pre><code class="language-java"><span class="hljs-keyword">static</span> 
State&lt;Pair&lt;Integer, Integer&gt;, Integer&gt; 
fib(Integer n) {
    StateM&lt;Pair&lt;Integer, Integer&gt;&gt; m = 
        <span class="hljs-keyword">new</span> StateM&lt;&gt;();
    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> State.narrow(
             m.flatMap(m.get,
        x -&gt; m.pure(x.first)));
    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> State.narrow(
             m.flatMap(m.get,
        x -&gt; m.pure(x.second)));
    
    <span class="hljs-keyword">return</span> State.narrow(
             m.flatMap(m.modify(x -&gt; 
                 <span class="hljs-keyword">new</span> Pair&lt;&gt;(x.second, 
                     x.first + x.second)),
        v -&gt; fib(n - <span class="hljs-number">1</span>)));
}
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
    System.out.println(
        fib(<span class="hljs-number">7</span>)
        .runState
        .apply(<span class="hljs-keyword">new</span> Pair&lt;&gt;(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>))
        .value);
}
</code></pre>
<p><code>fib</code> å‡½æ•°å¯¹åº”çš„ Haskell ä»£ç æ˜¯ï¼š</p>
<pre><code class="language-haskell"><span class="hljs-title">fib</span> :: <span class="hljs-type">Int</span> -&gt; <span class="hljs-type">State</span> (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>) <span class="hljs-type">Int</span>
<span class="hljs-title">fib</span> <span class="hljs-number">0</span> = <span class="hljs-keyword">do</span>
  (_, x) &lt;- get
  pure x
<span class="hljs-title">fib</span> n = <span class="hljs-keyword">do</span>
  modify (\(a, b) -&gt; (b, a + b))
  fib (n - <span class="hljs-number">1</span>)
</code></pre>
<p><del>çœ‹ä¸Šå»æ¯” Java ç‰ˆç®€å•å¾ˆå¤š</del></p>
<h2 id="æœ‰å•¥ç”¨">æœ‰å•¥ç”¨</h2>
<p>çœ‹åˆ°è¿™é‡Œè‚¯å®šæœ‰äººä¼šæ‹æ¡Œè€Œèµ·ï¼šæ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—æˆ‘æœ‰æ›´ç®€å•çš„å†™æ³•ï¼</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">fib</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>{
    <span class="hljs-keyword">int</span>[] a = {<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n - <span class="hljs-number">2</span>; i++)
        a[(i + <span class="hljs-number">3</span>) % <span class="hljs-number">3</span>] = a[(i + <span class="hljs-number">2</span>) % <span class="hljs-number">3</span>] + 
                         a[(i + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span>];
    <span class="hljs-keyword">return</span> a[n % <span class="hljs-number">3</span>];
}
</code></pre>
<p>ä½†é—®é¢˜æ˜¯ä½ ç”¨å˜é‡äº†å•Šï¼Œ <code>State Monad</code> æœ€å¦™çš„ä¸€ç‚¹å°±æ˜¯å…¨ç¨‹éƒ½æ˜¯å¸¸é‡è€Œæ¨¡æ‹Ÿå‡ºäº†å˜é‡çš„æ„Ÿè§‰ã€‚</p>
<p>æ›´ä½•å†µä½ è¿™é‡Œç”¨äº†æ•°ç»„è€Œä¸æ˜¯åœ¨é€’å½’ï¼Œå¦‚æœä½ é€’å½’å°±ä¼šéœ€è¦åœ¨ <code>fib</code> ä¸ŠåŠ ä¸€ä¸ªçŠ¶æ€å‚æ•°ï¼Œ <code>State Monad</code> å¯ä»¥åšåˆ°åœ¨ä¸æ·»åŠ ä»»ä½•å‡½æ•°å‚æ•°çš„æƒ…å†µä¸‹åœ¨å‡½æ•°ä¹‹é—´ä¼ é€’å‚æ•°ã€‚</p>
<p>åŒæ—¶å®ƒè¿˜æ˜¯çº¯çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯<strong>å¯ç»„åˆ</strong>çš„ï¼ŒæŠŠä»»æ„ä¸¤ä¸ªçŠ¶æ€ç±»å‹ç›¸åŒçš„ <code>State Monad</code> ç»„åˆèµ·æ¥å¹¶ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¯”å…¨å±€å˜é‡çš„è§£å†³æ–¹æ¡ˆä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»ã€‚</p>
</body>
</html>
